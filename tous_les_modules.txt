Module 01 : Creation tableau de source: 
Sub CreerTableauSource()
    Dim wsDonnees As Worksheet, wsSource As Worksheet, wsMateriel As Worksheet, wsParametres As Worksheet, wsManutention As Worksheet, wsCamion As Worksheet
    Dim lastRowDonnees As Long, lastRowMateriel As Long, lastRowSource As Long
    Dim i As Long, j As Long, k As Long
    Dim categorie As String, materiel As String, unite As String, typeCamion As String, nbPalettes As Long
    Dim etage As String
    Dim quantiteParCond As Double, quantite As Double, nbCond As Double
    Dim materielTrouve As Boolean
    Dim listPhase As Variant
    Dim filteredList As Object
    Dim cell As Range
    Dim resultString As String

    ' Définir les feuilles de travail
    Set wsDonnees = ThisWorkbook.Sheets("Données")
    Set wsSource = ThisWorkbook.Sheets("Tableau Source")
    Set wsMateriel = ThisWorkbook.Sheets("Matériel")
    Set wsManutention = ThisWorkbook.Sheets("Manutention")
    Set wsParametres = ThisWorkbook.Sheets("Paramétrage")
    Set wsCamion = ThisWorkbook.Sheets("Camion")
    
    ' Trouver la dernière ligne dans le bordereau
    lastRowDonnees = wsDonnees.Cells(wsDonnees.Rows.Count, "C").End(xlUp).Row
    lastRowMateriel = wsMateriel.Cells(wsMateriel.Rows.Count, "C").End(xlUp).Row
    lastRowManutention = wsManutention.Cells(wsManutention.Rows.Count, "A").End(xlUp).Row
    lastRowCamion = wsCamion.Cells(wsCamion.Rows.Count, "A").End(xlUp).Row
    
    
    
    ' Effacer tout le contenu et les formats
    wsSource.Cells.ClearContents
    wsSource.Cells.ClearFormats
    wsSource.Cells.Validation.Delete
    wsSource.Columns("P").FormatConditions.Delete
    wsSource.Columns("O").FormatConditions.Delete
    
    ' En-têtes
    wsSource.Cells(1, 1).Value = "Etage"
    wsSource.Cells(1, 2).Value = "Zone"
    wsSource.Cells(1, 3).Value = "Lot"
    wsSource.Cells(1, 4).Value = "Phase de traveaux"
    wsSource.Cells(1, 5).Value = "Nom de l'élément"
    wsSource.Cells(1, 6).Value = "Unité"
    wsSource.Cells(1, 7).Value = "Quantité"
    wsSource.Cells(1, 8).Value = "Conditionnement"
    wsSource.Cells(1, 9).Value = "Quantité par UM"
    wsSource.Cells(1, 10).Value = "Nombre d'UM nécessaires"
    wsSource.Cells(1, 11).Value = "Nombre palettes equivalent total"
    wsSource.Cells(1, 12).Value = "Type de camion requis"
    wsSource.Cells(1, 13).Value = "Nombre de camions nécessaires"
    wsSource.Cells(1, 14).Value = "Dont camions pleins"
    wsSource.Cells(1, 15).Value = "Remplissage camion non plein"
    wsSource.Cells(1, 16).Value = "Utilisation d'une CCC"

    
    ' Mise en forme : mettre les en-têtes en gras
    wsSource.Rows(1).Font.Bold = True
    wsSource.Rows(1).Font.Color = RGB(255, 255, 255)
    wsSource.Range(wsSource.Cells(1, 1), wsSource.Cells(1, 16)).Interior.Color = RGB(0, 32, 96)
    wsSource.Columns(1).Font.Bold = True
    wsSource.Columns(1).Font.Color = RGB(255, 255, 255)
    wsSource.Columns(1).Interior.Color = RGB(0, 32, 96)
    wsSource.Columns(2).Font.Bold = True
    
    lastColumnDonnees = wsDonnees.Cells(1, wsSource.Columns.Count).End(xlToLeft).Column
    Debug.Print lastColumnDonnees
        ' Boucle sur chaque étage dans le tableau source (à partir de la 3e colonne)
    For j = 5 To (lastColumnDonnees - 2)
        If wsDonnees.Cells(1, j).Value <> "" Then
            etage = wsDonnees.Cells(1, j).Value
        End If
        zone = wsDonnees.Cells(2, j).Value
        quantite = 0
        ' Boucle sur chaque matériel dans le tableau source
        For i = 4 To lastRowDonnees
            categorie = wsDonnees.Cells(i, 2).Value
            quantite = wsDonnees.Cells(i, j).Value
            
            
            If quantite > 0 Then
                ' Rechercher les informations complémentaires dans le tableau base de données
                For k = 2 To lastRowMateriel
                    If wsMateriel.Cells(k, 1).Value = categorie Then
                        lot = wsMateriel.Cells(k, 2).Value
                        
                        If lot = wsParametres.Cells(1, 2).Value Then
                             materiel = wsMateriel.Cells(k, 1).Value
                             unite = wsMateriel.Cells(k, 3).Value
                             phase = wsMateriel.Cells(k, 4).Value
                             utilisationCCC = wsMateriel.Cells(k, 5).Value
                             
                             lastRowSource = wsSource.Cells(wsSource.Rows.Count, 1).End(xlUp).Row + 1
                             wsSource.Cells(lastRowSource, 1).Value = etage
                             wsSource.Cells(lastRowSource, 2).Value = zone
                             wsSource.Cells(lastRowSource, 3).Value = lot
                             wsSource.Cells(lastRowSource, 4).Value = phase
                             wsSource.Cells(lastRowSource, 5).Value = materiel
                             wsSource.Cells(lastRowSource, 6).Value = unite
                             wsSource.Cells(lastRowSource, 7).Value = quantite
                             
                             If Not IsEmpty(wsMateriel.Cells(k, 7).Value) Then
                                wsSource.Cells(lastRowSource, 8).Value = wsMateriel.Cells(k, 7).Value
                             ElseIf Not IsEmpty(wsMateriel.Cells(k, 9).Value) Then
                                wsSource.Cells(lastRowSource, 8).Value = wsMateriel.Cells(k, 9).Value
                             ElseIf Not IsEmpty(wsMateriel.Cells(k, 11).Value) Then
                                wsSource.Cells(lastRowSource, 8).Value = wsMateriel.Cells(k, 11).Value
                             Else
                                wsSource.Cells(lastRowSource, 8).Value = "Palette"
                             End If
                             ' Ajoute la liste déroulante avec des options modifiables
                             With wsSource.Cells(lastRowSource, 8).Validation
                                 .Delete ' Supprime toute validation existante
                                 .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, Operator:= _
                                 xlBetween, Formula1:="='Manutention'!A2:A" & lastRowManutention ' Options de la liste déroulante
                                 .IgnoreBlank = True
                                 .InCellDropdown = True
                             End With
                             
                             
                             wsSource.Cells(lastRowSource, 9).Formula = "=INDEX(Matériel!A:Z, MATCH(E" & lastRowSource & ", Matériel!A:A, 0), MATCH(H" & lastRowSource & ", INDEX(Matériel!A:Z, MATCH(E" & lastRowSource & ", Matériel!A:A, 0), 0), 0) + 1)"

                             wsSource.Cells(lastRowSource, 10).Formula = "=ROUNDUP(G" & lastRowSource & " / I" & lastRowSource & "  , 0)"
            
                             ' Utiliser RECHERCHEV pour les informations complémentaires (nombre palettes equivalent, type camion)
                             wsSource.Cells(lastRowSource, 11).Formula = "=VLOOKUP(H" & lastRowSource & ",'Manutention'!A:E, 3, FALSE) * J" & lastRowSource
                             
                             Application.EnableEvents = False ' Désactive les événements pour éviter les boucles

                             ' Détermine le type de camion requis
                             nbPalettes = wsSource.Cells(lastRowSource, 11).Value
                             typeCamion = Application.WorksheetFunction.VLookup(wsSource.Cells(lastRowSource, 8).Value, wsManutention.Range("A:E"), 2, False)  'Type de camion requis
                                                             
                             ' Appeler la fonction OptimiserRemplissage et remplir la cellule de la colonne 12
                             wsSource.Cells(lastRowSource, 12).Value = OptimiserRemplissage(lastRowSource, typeCamion, nbPalettes)
                             
                             Application.EnableEvents = True ' Réactive les événements
                            
                             ' Initialisation des objets
                             Set filteredList = CreateObject("Scripting.Dictionary") ' Utilisation d'un dictionnaire pour éviter les doublons
                             resultString = ""
                            
                             ' Parcourir la feuille Camion pour trouver les valeurs correspondantes au type de camion
                             For Each cell In wsCamion.Range("A2:A" & lastRowCamion)
                                If wsCamion.Cells(cell.Row, "B").Value = typeCamion Then
                                    filteredList(wsCamion.Cells(cell.Row, "A").Value) = True ' Ajoute les valeurs à un dictionnaire
                                End If
                             Next cell
                            
                             ' Construire la chaîne pour la validation des données
                             If filteredList.Count > 0 Then
                                For Each key In filteredList.keys
                                    resultString = resultString & key & ","
                                Next key
                                resultString = Left(resultString, Len(resultString) - 1) ' Retirer la dernière virgule
                             Else
                                resultString = "Aucun" ' Si aucune correspondance trouvée
                             End If
                            
                             ' Ajoute la liste déroulante avec les options filtrées
                             With wsSource.Cells(lastRowSource, 12).Validation
                                .Delete ' Supprime toute validation existante
                                .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, Operator:= _
                                xlBetween, Formula1:=resultString ' Options de la liste déroulante
                                .IgnoreBlank = True
                                .InCellDropdown = True
                             End With

                             
                             wsSource.Cells(lastRowSource, 13).Formula = "=ROUNDUP(K" & lastRowSource & "/VLOOKUP(L" & lastRowSource & ",'Camion'!A:D, 3, FALSE),0)"
                             wsSource.Cells(lastRowSource, 14).Formula = "=INT(K" & lastRowSource & "/VLOOKUP(L" & lastRowSource & ",'Camion'!A:D, 3, FALSE))"
                             
                             
                             wsSource.Cells(lastRowSource, 15).Formula = "=ROUND(K" & lastRowSource & "/VLOOKUP(L" & lastRowSource & ",'Camion'!A:D, 3, FALSE) - N" & lastRowSource & ",2)"
                             wsSource.Cells(lastRowSource, 15).NumberFormat = "0%"
                             
                             Application.EnableEvents = False ' Désactive les événements pour éviter les boucles
                             wsSource.Cells(lastRowSource, 16).Value = utilisationCCC
                             Application.EnableEvents = True ' Réactive les événements
                     
                             ' Ajoute la liste déroulante avec des options modifiables
                             With wsSource.Cells(lastRowSource, 16).Validation
                                 .Delete ' Supprime toute validation existante
                                 .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, Operator:= _
                                 xlBetween, Formula1:="Oui,Non"  ' Options de la liste déroulante
                                 .IgnoreBlank = True
                                 .InCellDropdown = True
                             End With
                             
                             wsSource.Range(wsSource.Cells(lastRowSource, 2), wsSource.Cells(lastRowSource, 16)).Interior.Color = RGB(255, 255, 255)
                         End If
                         Exit For
                    End If
                Next k
            End If
        Next i
        
        listPhase = Array("Production", "Terminaux")
        For Each phase In listPhase
            lastRowSource = wsSource.Cells(wsSource.Rows.Count, 1).End(xlUp).Row + 1
            wsSource.Cells(lastRowSource, 1).Value = etage
            wsSource.Cells(lastRowSource, 2).Value = zone
            wsSource.Cells(lastRowSource, 5).Value = "Stock CCC " & phase
            wsSource.Cells(lastRowSource, 8).Value = "Palette"
            
            wsSource.Cells(lastRowSource, 11).Formula = "=SUMIFS(K:K, A:A, " & etage & ", B:B, """ & zone & """, P:P, ""Oui"", D:D, """ & phase & """)"
            
            Application.EnableEvents = False
            
            ' Détermine le type de camion requis
            nbPalettes = wsSource.Cells(lastRowSource, 11).Value
            typeCamion = Application.WorksheetFunction.VLookup(wsSource.Cells(lastRowSource, 8).Value, wsManutention.Range("A:E"), 2, False)  'Type de camion requis
                                                             
            ' Appeler la fonction OptimiserRemplissage et remplir la cellule de la colonne 12
            wsSource.Cells(lastRowSource, 12).Value = OptimiserRemplissage(lastRowSource, typeCamion, nbPalettes)
            
            Application.EnableEvents = True ' Réactive les événements
            
            ' Ajoute la liste déroulante avec des options modifiables
            With wsSource.Cells(lastRowSource, 12).Validation
                .Delete ' Supprime toute validation existante
                .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, Operator:=xlBetween, Formula1:="='Camion'!A2:A11"   ' Options de la liste déroulante
                .IgnoreBlank = True
                .InCellDropdown = True
            End With
            
            wsSource.Cells(lastRowSource, 13).Formula = "=ROUNDUP(K" & lastRowSource & "/VLOOKUP(L" & lastRowSource & ",'Camion'!A:D, 3, FALSE),0)"
            wsSource.Cells(lastRowSource, 14).Formula = "=INT(K" & lastRowSource & "/VLOOKUP(L" & lastRowSource & ",'Camion'!A:D, 3, FALSE))"
                                
            wsSource.Cells(lastRowSource, 15).Formula = "=ROUND(K" & lastRowSource & "/VLOOKUP(L" & lastRowSource & ",'Camion'!A:D, 3, FALSE) - N" & lastRowSource & ",2)"
            wsSource.Cells(lastRowSource, 15).NumberFormat = "0%"
            
            wsSource.Range(wsSource.Cells(lastRowSource, 3), wsSource.Cells(lastRowSource, 16)).Interior.Color = RGB(169, 208, 142)
        Next phase

    Next j
    
     ' Règle pour "Oui" : Remplissage vert, texte vert foncé
    With wsSource.Columns("P").FormatConditions.Add(Type:=xlTextString, String:="Oui", TextOperator:=xlContains)
        .Interior.Color = RGB(198, 239, 206) ' Vert clair
        .Font.Color = RGB(0, 97, 0) ' Vert foncé
    End With

    ' Règle pour "Non" : Remplissage rouge, texte rouge foncé
    With wsSource.Columns("P").FormatConditions.Add(Type:=xlTextString, String:="Non", TextOperator:=xlContains)
        .Interior.Color = RGB(255, 199, 206) ' Rouge
        .Font.Color = RGB(156, 0, 6) ' Rouge foncé
    End With

    ' Configurer les propriétés de la barre de données
    With wsSource.Columns("O").FormatConditions.AddDatabar
        ' Définir les valeurs minimales et maximales
        .MinPoint.Modify newtype:=xlConditionValueNumber, newvalue:=0
        .MaxPoint.Modify newtype:=xlConditionValueNumber, newvalue:=1

        ' Configurer la couleur de la barre
        .BarColor.Color = RGB(68, 114, 196) ' Bleu

        ' Activer ou désactiver les options d'affichage
        .ShowValue = True ' Afficher les valeurs dans les cellules
        .BarFillType = xlDataBarFillSolid ' Barres pleines
        .Direction = xlContext ' Direction par défaut selon la langue
    End With

    ' Adapter la largeur des colonnes
    wsSource.Columns.AutoFit
    wsSource.Range("A1").CurrentRegion.AutoFilter
    
End Sub








Module 01 : 
Sub CreerHistogrammeNombrePalettes()
    Dim ws As Worksheet, wsBilan As Worksheet, wsLivrable As Worksheet
    Dim chartObj As ChartObject
    Dim Chart As Chart
    Dim i As Long
    Dim lastRow As Long, lastRow2 As Long
    
    ' Définir la feuille
    Set ws = ThisWorkbook.Sheets("Bilan Graphique") ' Remplacez "Sheet1" par le nom de votre feuille
    Set wsBilan = ThisWorkbook.Sheets("Bilan")
    Set wsLivrable = ThisWorkbook.Sheets("Livrable")

    ' Dernière ligne de données
    lastRow = ws.Cells(ws.Rows.Count, 2).End(xlUp).Row
    lastRow2 = wsBilan.Cells(ws.Rows.Count, 3).End(xlUp).Row

    ' Créer un nouvel objet graphique
    Set chartObj = wsBilan.ChartObjects.Add(Left:=50, Width:=500, Top:=wsBilan.Cells(lastRow2 + 2, 1).Top, Height:=300)
    Set Chart = chartObj.Chart

    ' Définir le type de graphique (histogramme empilé)
    Chart.ChartType = xlColumnStacked

    ' Ajouter les séries de données
    Chart.SetSourceData Source:=ws.Range("C2:D" & lastRow)
    
    ' Configurer l'axe des catégories pour correspondre aux étages
    Chart.Axes(xlCategory).CategoryNames = ws.Range("B2:B" & lastRow)

    ' Configurer la légende (pour avoir "Production" et "Terminaux")
    Chart.HasLegend = True
    Chart.SeriesCollection(1).Name = "Production"
    Chart.SeriesCollection(2).Name = "Terminaux"
    
    ' Ajouter un titre au graphique
    Chart.HasTitle = True
    Chart.ChartTitle.Text = "Palettes équivalentes par étage"
    
    ' Ajouter un titre à l'axe des abscisses (axe des catégories)
    Chart.Axes(xlCategory, xlPrimary).HasTitle = True
    Chart.Axes(xlCategory, xlPrimary).AxisTitle.Text = "Étage et Zone" ' Titre de l'axe des abscisses

    ' Ajouter un titre à l'axe des ordonnées (axe des valeurs)
    Chart.Axes(xlValue, xlPrimary).HasTitle = True
    Chart.Axes(xlValue, xlPrimary).AxisTitle.Text = "Nombre de Palettes" ' Titre de l'axe des ordonnées

    ' Copiez le graphique
    chartObj.Copy
    
    ' Collez-le temporairement sur la feuille Livrable (par exemple, en A1)
    wsLivrable.Activate
    wsLivrable.Range("A1").Select
    wsLivrable.Paste
    
    ' Ajustez la position et la taille du graphique collé
    With wsLivrable.ChartObjects(wsLivrable.ChartObjects.Count)
        .Left = 180
        .Top = 145
        .Width = 299
        .Height = 130.5
        
        With .Chart
            ' Titre principal
            .ChartTitle.Font.Size = 12
        
            ' Titres des axes
            .Axes(xlCategory).AxisTitle.Font.Size = 7
            .Axes(xlCategory).TickLabels.Font.Size = 7
            .Axes(xlValue).AxisTitle.Font.Size = 7
            .Axes(xlValue).TickLabels.Font.Size = 7
        
            ' Légende
            .Legend.Font.Size = 7
        End With
    End With

End Sub



Sub CreerHistogrammeRemplissageCamions()
    Dim ws As Worksheet, wsBilan As Worksheet
    Dim chartObj As ChartObject
    Dim Chart As Chart
    Dim lastRow As Long

    ' Définir les feuilles
    Set ws = ThisWorkbook.Sheets("Bilan Graphique")
    Set wsBilan = ThisWorkbook.Sheets("Bilan")

    ' Dernière ligne de données
    lastRow = ws.Cells(ws.Rows.Count, 11).End(xlUp).Row
    lastRow2 = wsBilan.Cells(ws.Rows.Count, 3).End(xlUp).Row


    ' Créer un nouvel objet graphique
    Set chartObj = wsBilan.ChartObjects.Add(Left:=700, Width:=500, Top:=wsBilan.Cells(lastRow2 + 2, 1).Top, Height:=300)
    Set Chart = chartObj.Chart

    ' Définir les plages de données
    Dim xLabelsRange As Range, yValuesRange1 As Range, yValuesRange2 As Range
    Set xLabelsRange = ws.Range("B2:B" & lastRow) ' Colonne des catégories (par exemple "Étage - Zone")
    Set yValuesRange1 = ws.Range("K2:K" & lastRow) ' Remplissage sans CCC
    Set yValuesRange2 = ws.Range("L2:L" & lastRow) ' Remplissage avec CCC

    ' Ajouter une série pour l'histogramme
    Chart.SeriesCollection.NewSeries
    Chart.SeriesCollection(1).Name = "Remplissage camions sans CCC"
    Chart.SeriesCollection(1).Values = yValuesRange1
    Chart.SeriesCollection(1).XValues = xLabelsRange
    Chart.SeriesCollection(1).ChartType = xlColumnClustered ' Histogramme

    ' Ajouter une série pour la courbe
    Chart.SeriesCollection.NewSeries
    Chart.SeriesCollection(2).Name = "Remplissage camions avec CCC"
    Chart.SeriesCollection(2).Values = yValuesRange2
    Chart.SeriesCollection(2).XValues = xLabelsRange
    Chart.SeriesCollection(2).ChartType = xlColumnClustered ' Ligne avec marqueurs

    ' Ajouter un titre au graphique
    Chart.HasTitle = True
    Chart.ChartTitle.Text = "Comparaison du remplissage des camions par étage et zone"

    ' Configurer les axes
    Chart.Axes(xlCategory).HasTitle = True
    Chart.Axes(xlCategory).AxisTitle.Text = "Étage et Zone"
    Chart.Axes(xlValue).HasTitle = True
    Chart.Axes(xlValue).AxisTitle.Text = "Remplissage (%)"
End Sub




Sub CreerBilanZones()
    Dim wsSource As Worksheet
    Dim wsBilan As Worksheet
    Dim wsParametres As Worksheet
    Dim wsBilanGraphique As Worksheet, wsLivrable As Worksheet
    Dim lastRowDonnees As Long
    Dim currentZone As String, currentEtage As String
    Dim totalPalettes As Long, totalPalettesProd As Long, totalPalettesTerm As Long
    Dim i As Long, nextRow As Long, nextRow2 As Long
    Dim dernier As Long
    Dim sommeProd As Double, somme As Double
    Dim indexMatch As Variant, ligneStockCCC As Variant, ligneStockCCCProd As Variant, ligneStockCCCTerm As Variant
    Dim listeEtages As Range
    Dim chartObj As ChartObject
    Dim Chart As Chart
    Dim dictListeCamion As Object, dictListeCamionCCC As Object, dictListeMaterielCCC As Object
    Dim camionType As String, nombreCamion As Double, materiel As String, nombremateriel As Double
    Dim key As Variant
    Dim keys() As String
    Dim denominateur As Double
    Dim stockCCCProdM As Double, stockCCCProdN As Double, stockCCCProdO As Double
    Dim stockCCCTermM As Double, stockCCCTermN As Double, stockCCCTermO As Double
    
    
    ' Définir la feuille source contenant les données
    Set wsSource = ThisWorkbook.Sheets("Tableau Source") ' Remplacer par le nom de ta feuille
    lastRowDonnees = wsSource.Cells(wsSource.Rows.Count, "C").End(xlUp).Row ' Dernière ligne des données
    
    ' Créer une nouvelle feuille pour le résumé
    On Error Resume Next ' Eviter les erreurs si la feuille existe déjà
    Set wsBilan = ThisWorkbook.Sheets("Bilan")
    On Error GoTo 0
    
    If wsBilan Is Nothing Then
        Set wsBilan = ThisWorkbook.Sheets.Add
        wsBilan.Name = "Sortie"
    End If
    
    Set wsParametres = ThisWorkbook.Sheets("Paramétrage")
       
    dernier = wsParametres.Cells(wsSource.Rows.Count, "G").End(xlUp).Row
    Set listeZones = wsParametres.Range(wsParametres.Cells(3, 7), wsParametres.Cells(dernier, 7))
    
    
    'Configuration feuille Livrable
    
    Set wsLivrable = ThisWorkbook.Sheets("Livrable")
    For Each chartObj In wsLivrable.ChartObjects
        chartObj.Delete
    Next chartObj
    
    'Configuration feuille graphiques
    
    Set wsBilanGraphique = ThisWorkbook.Sheets("Bilan Graphique")
    wsBilanGraphique.Range("A:AB").ClearContents
    
    wsBilanGraphique.Cells(1, 2).Value = "Étage - Zone"
    wsBilanGraphique.Cells(1, 3).Value = "Production"
    wsBilanGraphique.Cells(1, 4).Value = "Terminaux"
    wsBilanGraphique.Cells(1, 6).Value = "Étage - Zone"
    wsBilanGraphique.Cells(1, 7).Value = "Camions Production sans CCC"
    wsBilanGraphique.Cells(1, 8).Value = "Camions Terminaux sans CCC"
    wsBilanGraphique.Cells(1, 9).Value = "Camions Production avec CCC"
    wsBilanGraphique.Cells(1, 10).Value = "Camions Terminaux avec CCC"
    wsBilanGraphique.Cells(1, 11).Value = "Remplissage camions sans CCC"
    wsBilanGraphique.Cells(1, 12).Value = "Remplissage camions avec CCC"
    
    
    
    ' Effacer tout le contenu et les formats
    wsBilan.Cells.ClearContents
    wsBilan.Cells.ClearFormats
    wsBilan.Cells.Validation.Delete
    
    For Each chartObj In wsBilan.ChartObjects
        chartObj.Delete
    Next chartObj
    
    ' Résumé volume
    ' Ajouter les en-têtes dans la feuille Résumé
    wsBilan.Cells(1, 1).Value = "Étage"
    wsBilan.Cells(1, 2).Value = "Zone"
    wsBilan.Cells(1, 3).Value = "Phase"
    wsBilan.Cells(1, 4).Value = "Total Palettes Équivalent"

    wsBilan.Cells.Columns(1).Font.Bold = True
    wsBilan.Cells.Columns(1).Font.Color = RGB(255, 255, 255)
    wsBilan.Cells.Columns(2).Font.Color = RGB(255, 255, 255)
    wsBilan.Cells.Rows(1).Font.Bold = True
    wsBilan.Cells.Rows(1).Font.Color = RGB(255, 255, 255)
    wsBilan.Cells.Range(wsBilan.Cells(1, 1), wsBilan.Cells(1, 4)).Interior.Color = RGB(0, 32, 96)
    
    
    nextRow = 2 ' La ligne suivante après les en-têtes
    
    ' Initialiser les variables pour stocker les étages et zones actuels
    currentEtage = ""
    currentZone = ""
    
    totalPalettes = 0
    totalPalettesProd = 0
    totalPalettesTerm = 0
    
    ' Initialiser les dictionnaires
    Set dictListeCamion = CreateObject("Scripting.Dictionary")
    Set dictListeCamionCCC = CreateObject("Scripting.Dictionary")
    Set dictListeMaterielCCC = CreateObject("Scripting.Dictionary")

    ' Boucler sur les lignes de la feuille source
    For i = 2 To lastRowDonnees

        currentEtage = wsSource.Cells(i, 1).Value
        currentZone = wsSource.Cells(i, 2).Value
        
        ' Ajouter les palettes de la ligne courante au total pour la zone
        If wsSource.Cells(i, 16).Value <> "" Then
            totalPalettes = totalPalettes + wsSource.Cells(i, 11).Value
        End If
        
        If wsSource.Cells(i, 4).Value = "Production" Then
            totalPalettesProd = totalPalettesProd + wsSource.Cells(i, 11).Value
        End If
        
        If wsSource.Cells(i, 4).Value = "Terminaux" Then
            totalPalettesTerm = totalPalettesTerm + wsSource.Cells(i, 11).Value
        End If
        
        
        ' Vérifier si on passe à une nouvelle zone ou si c'est la dernière ligne
        If wsSource.Cells(i + 1, 1).Value <> currentEtage Or wsSource.Cells(i + 1, 2).Value <> currentZone Or i = lastRowDonnees Then
            ' Remplir les données dans la feuille Résumé UNE SEULE FOIS PAR ZONE
            wsBilan.Cells(nextRow, 1).Value = currentEtage ' Étage
            wsBilan.Cells(nextRow, 1).Interior.Color = RGB(0, 32, 96)
            wsBilan.Cells(nextRow, 2).Value = currentZone ' Zone
            wsBilan.Cells(nextRow, 2).Interior.Color = RGB(0, 32, 96)
            wsBilan.Cells(nextRow, 3).Value = "Production" ' Total palettesProd
            wsBilan.Cells(nextRow + 1, 3).Value = "Terminaux" ' Total palettesTerm
            wsBilan.Cells(nextRow + 2, 3).Value = "Total" ' Total palettes
            wsBilan.Cells(nextRow + 2, 3).Font.Bold = True
            wsBilan.Cells(nextRow, 4).Value = totalPalettesProd ' Total palettesProd
            wsBilan.Cells(nextRow + 1, 4).Value = totalPalettesTerm ' Total palettesTerm
            wsBilan.Cells(nextRow + 2, 4).Value = totalPalettes ' Total palettes
            wsBilan.Cells(nextRow + 2, 4).Font.Bold = True
            wsBilan.Cells.Range(wsBilan.Cells(nextRow + 1, 3), wsBilan.Cells(nextRow + 1, 4)).Interior.Color = wsSource.Cells(i, 2).Interior.Color
            
            
            nextRow = nextRow + 3
            
            'Stocker dans la feuille graphique
            wsBilanGraphique.Cells(nextRow / 3, 2).Value = currentEtage & " - " & currentZone
            wsBilanGraphique.Cells(nextRow / 3, 3).Value = totalPalettesProd
            wsBilanGraphique.Cells(nextRow / 3, 4).Value = totalPalettesTerm
            
            ' Réinitialiser pour la zone suivante
            totalPalettes = 0
            totalPalettesProd = 0
            totalPalettesTerm = 0
            
        End If
        If wsSource.Cells(i, 16).Value <> "" Then
            camionType = wsSource.Cells(i, 12).Value
            nombreCamion = wsSource.Cells(i, 13).Value
            key = currentEtage & currentZone & "|" & camionType
            If Not dictListeCamion.exists(key) Then
                dictListeCamion.Add key, nombreCamion
            Else
                dictListeCamion(key) = dictListeCamion(key) + nombreCamion
            End If
        End If
        
        If wsSource.Cells(i, 16).Value <> "Oui" Then
            camionType = wsSource.Cells(i, 12).Value
            nombreCamion = wsSource.Cells(i, 13).Value
            key = currentEtage & currentZone & "|" & camionType
            If Not dictListeCamionCCC.exists(key) Then
                dictListeCamionCCC.Add key, nombreCamion
            Else
                dictListeCamionCCC(key) = dictListeCamionCCC(key) + nombreCamion
            End If
        End If
        
        If wsSource.Cells(i, 16).Value = "Oui" Then
            materiel = wsSource.Cells(i, 5).Value
            nombremateriel = wsSource.Cells(i, 7).Value
            key = materiel
            If Not dictListeMaterielCCC.exists(key) Then
                dictListeMaterielCCC.Add key, nombreCamion
            Else
                dictListeMaterielCCC(key) = dictListeMaterielCCC(key) + nombremateriel
            End If
        End If
    Next i
    
    
    ' Insérer les résultats dans la feuille
    wsBilanGraphique.Cells(1, 18).Value = "Étage"
    wsBilanGraphique.Cells(1, 19).Value = "Zone"
    wsBilanGraphique.Cells(1, 20).Value = "Type de Camion"
    wsBilanGraphique.Cells(1, 21).Value = "Nombre de Camions"

    i = 2
    For Each key In dictListeCamion.keys
        keys = Split(key, "|")
        wsBilanGraphique.Cells(i, 19).Value = keys(0) ' Étages et zones
        wsBilanGraphique.Cells(i, 20).Value = keys(1) ' Type de camion
        wsBilanGraphique.Cells(i, 21).Value = dictListeCamion(key) ' Nombre de camions
        i = i + 1
    Next key
    
    ' Insérer les résultats dans la feuille
    wsBilanGraphique.Cells(1, 23).Value = "Étage"
    wsBilanGraphique.Cells(1, 24).Value = "Type de Camion"
    wsBilanGraphique.Cells(1, 25).Value = "Nombre de Camions avec CCC"
    
    i = 2
    For Each key In dictListeCamionCCC.keys
        keys = Split(key, "|")
        wsBilanGraphique.Cells(i, 23).Value = keys(0) ' Étages
        wsBilanGraphique.Cells(i, 24).Value = keys(1) ' Type de camion
        wsBilanGraphique.Cells(i, 25).Value = dictListeCamionCCC(key) ' Nombre de camions
        i = i + 1
    Next key
    
    wsBilanGraphique.Cells(1, 27).Value = "Matériel CCC"
    wsBilanGraphique.Cells(1, 28).Value = "Nombre de matériels CCC"
    i = 2
    For Each key In dictListeMaterielCCC.keys
        keys = Split(key, "|")
        wsBilanGraphique.Cells(i, 27).Value = keys(0) ' matériel
        wsBilanGraphique.Cells(i, 28).Value = dictListeMaterielCCC(key) ' Nombre de matériels
        i = i + 1
    Next key
    
    
    
    wsBilan.Cells(nextRow, 2).Value = "Total"
    wsBilan.Cells(nextRow, 2).Font.Bold = True
    wsBilan.Cells(nextRow, 3).Value = "Production" ' Total palettesProd
    wsBilan.Cells(nextRow + 1, 3).Value = "Terminaux" ' Total palettesTerm
    wsBilan.Cells(nextRow + 2, 3).Value = "Total" ' Total palettes
    wsBilan.Cells(nextRow, 4).Value = WorksheetFunction.SumIf(wsBilan.Range(wsBilan.Cells(2, 3), wsBilan.Cells(nextRow - 1, 3)), "Production", _
            wsBilan.Range(wsBilan.Cells(2, 4), wsBilan.Cells(nextRow - 1, 4)))
    wsBilan.Cells(nextRow + 1, 4).Value = WorksheetFunction.SumIf(wsBilan.Range(wsBilan.Cells(2, 3), wsBilan.Cells(nextRow - 1, 3)), "Terminaux", _
            wsBilan.Range(wsBilan.Cells(2, 4), wsBilan.Cells(nextRow - 1, 4)))
    wsBilan.Cells(nextRow + 2, 4).Value = wsBilan.Cells(nextRow, 4).Value + wsBilan.Cells(nextRow + 1, 4).Value


    wsBilan.Cells.Range(wsBilan.Cells(nextRow, 1), wsBilan.Cells(nextRow + 2, 4)).Interior.Color = RGB(0, 112, 192)
    wsBilan.Cells.Range(wsBilan.Cells(nextRow + 2, 3), wsBilan.Cells(nextRow + 2, 4)).Font.Bold = True
    wsBilan.Cells.Range(wsBilan.Cells(nextRow, 2), wsBilan.Cells(nextRow + 2, 4)).Font.Color = RGB(255, 255, 255)
    
    ' Résumé Camions

    ' Ajouter les en-têtes dans la feuille Résumé
    wsBilan.Cells(1, 6).Value = "Étage"
    wsBilan.Cells(1, 7).Value = "Zone"
    wsBilan.Cells(1, 8).Value = "Phase"
    wsBilan.Cells(1, 9).Value = "Nombre total de camions sans CCC"
    wsBilan.Cells(1, 10).Value = "Nombre total de camions avec CCC"
    wsBilan.Cells(1, 11).Value = "Remplissage moyen sans CCC"
    wsBilan.Cells(1, 12).Value = "Remplissage moyen avec CCC"
    
    wsBilan.Cells.Columns(6).Font.Bold = True
    wsBilan.Cells.Columns(6).Font.Color = RGB(255, 255, 255)
    wsBilan.Cells.Columns(7).Font.Color = RGB(255, 255, 255)
    wsBilan.Cells.Range(wsBilan.Cells(1, 6), wsBilan.Cells(1, 12)).Interior.Color = RGB(0, 32, 96)
    
    
    nextRow = 2 ' La ligne suivante après les en-têtes
    nextRow2 = 2
    
    
    
    ' Boucler sur les lignes de la feuille source
    For Each zone In listeZones
        etage = wsBilan.Cells(nextRow, 1).Value
        wsBilan.Cells(nextRow, 6).Value = etage ' Étage
        wsBilan.Cells(nextRow, 6).Interior.Color = RGB(0, 32, 96)
        
        wsBilan.Cells(nextRow, 7).Value = zone ' Étage
        wsBilan.Cells(nextRow, 7).Interior.Color = RGB(0, 32, 96)
        
        wsBilan.Cells(nextRow, 8).Value = "Production" ' Total palettesProd
        wsBilan.Cells(nextRow + 1, 8).Value = "Terminaux"
        wsBilan.Cells(nextRow + 2, 8).Value = "Total"
        wsBilan.Cells(nextRow + 2, 8).Font.Bold = True
        
        wsBilan.Cells(nextRow, 9).Value = WorksheetFunction.SumIfs( _
                                                            wsSource.Range("M:M"), _
                                                            wsSource.Range("A:A"), etage, _
                                                            wsSource.Range("B:B"), zone, _
                                                            wsSource.Range("P:P"), "<>", _
                                                            wsSource.Range("D:D"), "Production")
        wsBilan.Cells(nextRow + 1, 9).Value = WorksheetFunction.SumIfs( _
                                                            wsSource.Range("M:M"), _
                                                            wsSource.Range("A:A"), etage, _
                                                            wsSource.Range("B:B"), zone, _
                                                            wsSource.Range("P:P"), "<>", _
                                                            wsSource.Range("D:D"), "Terminaux")
        wsBilan.Cells(nextRow + 2, 9).Value = wsBilan.Cells(nextRow, 9).Value + wsBilan.Cells(nextRow + 1, 9).Value
        wsBilan.Cells(nextRow + 2, 9).Font.Bold = True
        
        ligneStockCCCProd = wsSource.Evaluate("MATCH(1, INDEX((A:A=" & etage & ")*(B:B=""" & zone & """)*(P:P=""""), 0), 0)")
        If IsError(ligneStockCCCProd) Or ligneStockCCCProd < 1 Then
            ligneStockCCCProd = 0
            ligneStockCCCTerm = 0
            stockCCCProdM = 0: stockCCCProdN = 0: stockCCCProdO = 0
            stockCCCTermM = 0: stockCCCTermN = 0: stockCCCTermO = 0
        Else
            ligneStockCCCProd = CLng(ligneStockCCCProd)
            ligneStockCCCTerm = ligneStockCCCProd + 1
            stockCCCProdM = stockCCCProdM
            stockCCCProdN = stockCCCProdN
            stockCCCProdO = stockCCCProdO
            stockCCCTermM = stockCCCTermM
            stockCCCTermN = stockCCCTermN
            stockCCCTermO = stockCCCTermO
        End If
        
        
        wsBilan.Cells(nextRow, 10).Value = WorksheetFunction.SumIfs(wsSource.Range("M:M"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non", wsSource.Range("D:D"), "Production") + _
                                                            stockCCCProdM
        wsBilan.Cells(nextRow + 1, 10).Value = WorksheetFunction.SumIfs(wsSource.Range("M:M"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non", wsSource.Range("D:D"), "Terminaux") + _
                                                            stockCCCTermM
        wsBilan.Cells(nextRow + 2, 10).Value = wsBilan.Cells(nextRow, 10).Value + wsBilan.Cells(nextRow + 1, 10).Value
        wsBilan.Cells(nextRow + 2, 10).Font.Bold = True
        
        wsBilan.Cells(nextRow, 11).Value = WorksheetFunction.RoundUp(( _
                                                            WorksheetFunction.SumIfs(wsSource.Range("O:O"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "<>", wsSource.Range("D:D"), "Production") + _
                                                            WorksheetFunction.SumIfs(wsSource.Range("N:N"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "<>", wsSource.Range("D:D"), "Production")) / _
                                                            WorksheetFunction.SumIfs(wsSource.Range("M:M"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "<>", wsSource.Range("D:D"), "Production"), 2)
        
        denominateur = WorksheetFunction.SumIfs(wsSource.Range("M:M"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "<>", wsSource.Range("D:D"), "Terminaux")

        If denominateur = 0 Then
            wsBilan.Cells(nextRow + 1, 11).Value = 0
        Else
            wsBilan.Cells(nextRow + 1, 11).Value = WorksheetFunction.RoundUp( _
                (WorksheetFunction.SumIfs(wsSource.Range("O:O"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "<>", wsSource.Range("D:D"), "Terminaux") + _
                 WorksheetFunction.SumIfs(wsSource.Range("N:N"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "<>", wsSource.Range("D:D"), "Terminaux")) / denominateur, 2)
        End If
        wsBilan.Cells(nextRow + 2, 11).Value = WorksheetFunction.RoundUp(( _
                                                            WorksheetFunction.SumIfs(wsSource.Range("O:O"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "<>") + _
                                                            WorksheetFunction.SumIfs(wsSource.Range("N:N"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "<>")) / _
                                                            WorksheetFunction.SumIfs(wsSource.Range("M:M"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "<>"), 2)
        wsBilan.Cells(nextRow + 2, 11).Font.Bold = True
        
        
        wsBilan.Cells(nextRow, 12).Value = WorksheetFunction.RoundUp(( _
                                                            WorksheetFunction.SumIfs(wsSource.Range("O:O"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non", wsSource.Range("D:D"), "Production") + _
                                                            WorksheetFunction.SumIfs(wsSource.Range("N:N"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non", wsSource.Range("D:D"), "Production") + _
                                                            stockCCCProdO + _
                                                            stockCCCProdN) / ( _
                                                            WorksheetFunction.SumIfs(wsSource.Range("M:M"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non", wsSource.Range("D:D"), "Production") + _
                                                            stockCCCProdM _
                                                           ), 2)
                                                           
        ' Calcul du dénominateur
        denominator = WorksheetFunction.SumIfs(wsSource.Range("M:M"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non", wsSource.Range("D:D"), "Terminaux") + _
              stockCCCTermM
        If denominateur = 0 Then
            wsBilan.Cells(nextRow + 1, 12).Value = 0
        Else
            wsBilan.Cells(nextRow + 1, 12).Value = WorksheetFunction.RoundUp(( _
                                                            WorksheetFunction.SumIfs(wsSource.Range("O:O"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non", wsSource.Range("D:D"), "Terminaux") + _
                                                            WorksheetFunction.SumIfs(wsSource.Range("N:N"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non", wsSource.Range("D:D"), "Terminaux") + _
                                                            stockCCCTermO + _
                                                            stockCCCTermN) / ( _
                                                            WorksheetFunction.SumIfs(wsSource.Range("M:M"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non", wsSource.Range("D:D"), "Terminaux") + _
                                                            stockCCCTermM _
                                                            ), 2)
        End If
        
        
        wsBilan.Cells(nextRow + 2, 12).Value = WorksheetFunction.RoundUp(( _
                                                            WorksheetFunction.SumIfs(wsSource.Range("O:O"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non") + _
                                                            WorksheetFunction.SumIfs(wsSource.Range("N:N"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non") + _
                                                            stockCCCProdO + _
                                                            stockCCCTermO + _
                                                            stockCCCProdN + _
                                                            stockCCCTermN) / ( _
                                                            WorksheetFunction.SumIfs(wsSource.Range("M:M"), wsSource.Range("A:A"), etage, wsSource.Range("B:B"), zone, wsSource.Range("P:P"), "Non") + _
                                                            stockCCCProdM + _
                                                            stockCCCTermM _
                                                            ), 2)
        wsBilan.Cells(nextRow + 2, 12).Font.Bold = True
    
        
        wsBilan.Cells.Range(wsBilan.Cells(nextRow + 1, 8), wsBilan.Cells(nextRow + 1, 12)).Interior.Color = wsSource.Cells(i, 2).Interior.Color
        
        'Stocker dans la feuille graphique
        wsBilanGraphique.Cells(nextRow2, 6).Value = etage & " - " & zone
        wsBilanGraphique.Cells(nextRow2, 7).Value = wsBilan.Cells(nextRow, 9).Value
        wsBilanGraphique.Cells(nextRow2, 8).Value = wsBilan.Cells(nextRow + 1, 9).Value
        wsBilanGraphique.Cells(nextRow2 + 1, 9).Value = wsBilan.Cells(nextRow, 10).Value
        wsBilanGraphique.Cells(nextRow2 + 1, 10).Value = wsBilan.Cells(nextRow + 1, 10).Value
        wsBilanGraphique.Cells((nextRow + 3) / 3, 11).Value = wsBilan.Cells(nextRow + 2, 11).Value * 100
        wsBilanGraphique.Cells((nextRow + 3) / 3, 12).Value = wsBilan.Cells(nextRow + 2, 12).Value * 100
        
        
        nextRow = nextRow + 3
        nextRow2 = nextRow2 + 2

        

    Next zone
    
    
    
    wsBilan.Cells(nextRow, 7).Value = "Total"
    wsBilan.Cells(nextRow, 8).Value = "Production"
    wsBilan.Cells(nextRow + 1, 8).Value = "Terminaux"
    wsBilan.Cells(nextRow + 2, 8).Value = "Total"
    
    'Totaux Nombre total de camions sans CCC
    
    wsBilan.Cells(nextRow, 9).Value = WorksheetFunction.SumIf(wsBilan.Range(wsBilan.Cells(2, 8), wsBilan.Cells(nextRow - 1, 8)), "Production", _
            wsBilan.Range(wsBilan.Cells(2, 9), wsBilan.Cells(nextRow - 1, 9)))
    wsBilan.Cells(nextRow + 1, 9).Value = WorksheetFunction.SumIf(wsBilan.Range(wsBilan.Cells(2, 8), wsBilan.Cells(nextRow - 1, 8)), "Terminaux", _
            wsBilan.Range(wsBilan.Cells(2, 9), wsBilan.Cells(nextRow - 1, 9)))
    wsBilan.Cells(nextRow + 2, 9).Value = wsBilan.Cells(nextRow, 9).Value + wsBilan.Cells(nextRow + 1, 9).Value
    
    'Totaux Nombre total de camions avec CCC

    wsBilan.Cells(nextRow, 10).Value = WorksheetFunction.SumIf(wsBilan.Range(wsBilan.Cells(2, 8), wsBilan.Cells(nextRow - 1, 8)), "Production", _
            wsBilan.Range(wsBilan.Cells(2, 10), wsBilan.Cells(nextRow - 1, 10)))
    wsBilan.Cells(nextRow + 1, 10).Value = WorksheetFunction.SumIf(wsBilan.Range(wsBilan.Cells(2, 8), wsBilan.Cells(nextRow - 1, 8)), "Terminaux", _
            wsBilan.Range(wsBilan.Cells(2, 10), wsBilan.Cells(nextRow - 1, 10)))
    wsBilan.Cells(nextRow + 2, 10).Value = wsBilan.Cells(nextRow, 10).Value + wsBilan.Cells(nextRow + 1, 10).Value
    
    'Totaux Remplissage moyen sans CCC

    
    ' Initialise les sommes
    sommeProd = 0
    somme = 0
    
    ' Boucle sur chaque ligne de la plage pour appliquer la condition
    For i = 2 To nextRow - 1
        If wsBilan.Cells(i, 8).Value = "Production" Then ' Vérifie si la colonne H (colonne 8) contient "Total"
            sommeProd = sommeProd + (wsBilan.Cells(i, 9).Value * wsBilan.Cells(i, 11).Value)
            somme = somme + wsBilan.Cells(i, 9).Value
        End If
    Next i
    wsBilan.Cells(nextRow, 11).Value = WorksheetFunction.RoundUp(sommeProd / somme, 2)
    
    ' Initialise les sommes
    sommeProd = 0
    somme = 0
    
    ' Boucle sur chaque ligne de la plage pour appliquer la condition
    For i = 2 To nextRow - 1
        If wsBilan.Cells(i, 8).Value = "Terminaux" Then ' Vérifie si la colonne H (colonne 8) contient "Total"
            sommeProd = sommeProd + (wsBilan.Cells(i, 9).Value * wsBilan.Cells(i, 11).Value)
            somme = somme + wsBilan.Cells(i, 9).Value
        End If
    Next i
    
    denominateur = somme
    If denominateur = 0 Then
        wsBilan.Cells(nextRow + 1, 11).Value = 0
    Else
        wsBilan.Cells(nextRow + 1, 11).Value = WorksheetFunction.RoundUp(sommeProd / somme, 2)
    End If
     ' Initialise les sommes
    sommeProd = 0
    somme = 0
    
    ' Boucle sur chaque ligne de la plage pour appliquer la condition
    For i = 2 To nextRow - 1
        If wsBilan.Cells(i, 8).Value = "Total" Then ' Vérifie si la colonne H (colonne 8) contient "Total"
            sommeProd = sommeProd + (wsBilan.Cells(i, 9).Value * wsBilan.Cells(i, 11).Value)
            somme = somme + wsBilan.Cells(i, 9).Value
        End If
    Next i
    wsBilan.Cells(nextRow + 2, 11).Value = WorksheetFunction.RoundUp(sommeProd / somme, 2)
    
    
    
    
    'Totaux Remplissage moyen avec CCC


    ' Initialise les sommes
    sommeProd = 0
    somme = 0
    
    ' Boucle sur chaque ligne de la plage pour appliquer la condition
    For i = 2 To nextRow - 1
        If wsBilan.Cells(i, 8).Value = "Production" Then ' Vérifie si la colonne H (colonne 8) contient "Total"
            sommeProd = sommeProd + (wsBilan.Cells(i, 9).Value * wsBilan.Cells(i, 12).Value)
            somme = somme + wsBilan.Cells(i, 9).Value
        End If
    Next i
    wsBilan.Cells(nextRow, 12).Value = WorksheetFunction.RoundUp(sommeProd / somme, 2)
    
    ' Initialise les sommes
    sommeProd = 0
    somme = 0
    
    ' Boucle sur chaque ligne de la plage pour appliquer la condition
    For i = 2 To nextRow - 1
        If wsBilan.Cells(i, 8).Value = "Terminaux" Then ' Vérifie si la colonne H (colonne 8) contient "Total"
            sommeProd = sommeProd + (wsBilan.Cells(i, 9).Value * wsBilan.Cells(i, 12).Value)
            somme = somme + wsBilan.Cells(i, 9).Value
        End If
    Next i
    denominateur = somme
    If denominateur = 0 Then
        wsBilan.Cells(nextRow + 1, 12).Value = 0
    Else
        wsBilan.Cells(nextRow + 1, 12).Value = WorksheetFunction.RoundUp(sommeProd / somme, 2)
    End If
    
    
    ' Initialise les sommes
    sommeProd = 0
    somme = 0
    
    ' Boucle sur chaque ligne de la plage pour appliquer la condition
    For i = 2 To nextRow - 1
        If wsBilan.Cells(i, 8).Value = "Total" Then ' Vérifie si la colonne H (colonne 8) contient "Total"
            sommeProd = sommeProd + (wsBilan.Cells(i, 9).Value * wsBilan.Cells(i, 12).Value)
            somme = somme + wsBilan.Cells(i, 9).Value
        End If
    Next i
    wsBilan.Cells(nextRow + 2, 12).Value = WorksheetFunction.RoundUp(sommeProd / somme, 2)




    wsBilan.Cells.Range(wsBilan.Cells(nextRow + 2, 6), wsBilan.Cells(nextRow, 12)).Interior.Color = RGB(0, 112, 192)
    wsBilan.Cells.Range(wsBilan.Cells(nextRow + 2, 7), wsBilan.Cells(nextRow + 2, 12)).Font.Bold = True
    wsBilan.Cells.Range(wsBilan.Cells(nextRow + 2, 7), wsBilan.Cells(nextRow, 12)).Font.Color = RGB(255, 255, 255)
    
    wsBilan.Range("K2:L" & (nextRow + 2)).NumberFormat = "0%"
    
    ' === Copier Materiel Global depuis Données vers Bilan Graphique ===
    With ThisWorkbook
        .Sheets("Bilan Graphique").Range("AC2:AC4998").Value = .Sheets("Données").Range("B4:B5000").Value
        .Sheets("Bilan Graphique").Range("AD2:AD4998").Value = .Sheets("Données").Range("C4:C5000").Value
    End With
    
    ' Ajuster la mise en forme (facultatif)
    wsBilan.Columns("A:L").AutoFit
    
    Call CreerHistogrammeNombrePalettes
    Call CreerHistogrammeNombreCamions
    Call CreerHistogrammeRemplissageCamions
    Call CreerGraphiqueFluxMensuel
    Call CreerLivrable

End Sub







Module 4 : 
Sub CreerGraphiqueFluxMensuel()
    Dim ws As Worksheet
    Dim wsBilan As Worksheet, wsParametres As Worksheet, wsLivrable As Worksheet
    Dim chartObj As ChartObject
    Dim Chart As Chart
    Dim i As Long, j As Long, k As Integer
    Dim lastRow As Long, lastRow2 As Long
    Dim dict As Object
    Dim key As Variant
    Dim dateDebut As Date
    Dim dureeEtage As Integer
    Dim nombreMois As Integer, repartitionActuelle As Double, repartitionReste As Double
    Dim moisAnnee As String
    Dim volume As Double
    Dim camions As Long, camionsCCC As Long
    Dim tempArray As Variant
    Dim moisArray() As Date
    Dim sorted As Boolean

    ' Définir la feuille source et créer une feuille pour les flux mensuels
    Set wsBilan = ThisWorkbook.Sheets("Bilan") ' Remplacez "Données" par le nom de votre feuille source
    Set ws = ThisWorkbook.Sheets("Bilan Graphique")
    Set wsParametres = ThisWorkbook.Sheets("Paramétrage")
    Set wsLivrable = ThisWorkbook.Sheets("Livrable")

    ' Initialiser un dictionnaire pour l'agrégation
    Set dict = CreateObject("Scripting.Dictionary")

    ' Parcourir les données de livraison pour regrouper par mois/année
    lastRow = wsParametres.Cells(ws.Rows.Count, "I").End(xlUp).Row
    lastRow2 = wsBilan.Cells(ws.Rows.Count, 3).End(xlUp).Row
    
    j = 2 ' Index pour les lignes des camions
    
    For i = 3 To lastRow
        ' Date de début et durée
        dateDebut = wsParametres.Cells(i, "H").Value - wsParametres.Cells(i, "J").Value ' Date de début
        dureeEtage = wsParametres.Cells(i, "K").Value ' Durée en jours
        ' Calcul du nombre de mois (arrondi à l'entier supérieur)
        nombreMois = Application.WorksheetFunction.RoundUp(dureeEtage / 30, 0)
        ' Récupération des valeurs
        volume = ws.Cells(i - 1, "C").Value
        camions = ws.Cells(j, "G").Value
        camionsCCC = ws.Cells(j + 1, "I").Value
        j = j + 2 ' Incrémentation pour les prochaines lignes de camions
    
        ' Répartition des livraisons :
        ' - 50% dès le premier mois
        ' - Le reste réparti uniformément sur les mois suivants
        If nombreMois = 1 Then
            ' Si un seul mois, on livre tout en une fois
            repartitionReste = 1
        Else
            repartitionReste = 0.5 / (nombreMois - 1) ' Répartition du reste sur les mois suivants
        End If
    
        ' Répartition des livraisons sur plusieurs mois
        For k = 0 To nombreMois - 1
            moisAnnee = Format(DateAdd("m", k, dateDebut), "yyyy-mm")
            If nombreMois = 1 Then
                repartitionActuelle = 1 ' Tout livrer en un seul mois
            ElseIf k = 0 Then
                repartitionActuelle = 0.5 ' 50% au premier mois
            Else
                repartitionActuelle = repartitionReste ' Répartition du reste sur les autres mois
            End If
    
            ' Ajouter au dictionnaire ou mettre à jour les valeurs
            If Not dict.exists(moisAnnee) Then
                dict.Add moisAnnee, Array(volume * repartitionActuelle, camions * repartitionActuelle, camionsCCC * repartitionActuelle)
            Else
                tempArray = dict(moisAnnee)
                tempArray(0) = tempArray(0) + (volume * repartitionActuelle)   ' Mettre à jour le volume
                tempArray(1) = tempArray(1) + (camions * repartitionActuelle)  ' Mettre à jour les camions
                tempArray(2) = tempArray(2) + (camionsCCC * repartitionActuelle) ' Mettre à jour les camions CCC
                dict(moisAnnee) = tempArray ' Réassigner le tableau mis à jour au dictionnaire
            End If
        Next k
    Next i
    
    j = 2
    For i = 3 To lastRow
        ' Date de début et durée
        dateDebut = wsParametres.Cells(i, "I").Value - wsParametres.Cells(i, "J").Value ' Date de début
        dureeEtage = wsParametres.Cells(i, "L").Value ' Durée en jours
    
        ' Calcul du nombre de mois (arrondi à l'entier supérieur)
        nombreMois = Application.WorksheetFunction.RoundUp(dureeEtage / 30, 0)
    
        ' Récupération des valeurs
        volume = ws.Cells(i - 1, "D").Value
        camions = ws.Cells(j, "H").Value
        camionsCCC = ws.Cells(j + 1, "J").Value
        j = j + 2 ' Incrémentation pour les prochaines lignes de camions
        
        ' Répartition des livraisons :
        ' - 50% dès le premier mois
        ' - Le reste réparti uniformément sur les mois suivants
        If nombreMois = 1 Then
            ' Si un seul mois, on livre tout en une fois
            repartitionReste = 1
        Else
            repartitionReste = 0.5 / (nombreMois - 1) ' Répartition du reste sur les mois suivants
        End If
    
        ' Répartition des livraisons sur plusieurs mois
        For k = 0 To nombreMois - 1
            moisAnnee = Format(DateAdd("m", k, dateDebut), "yyyy-mm")
            If nombreMois = 1 Then
                repartitionActuelle = 1 ' Tout livrer en un seul mois
            ElseIf k = 0 Then
                repartitionActuelle = 0.5 ' 50% au premier mois
            Else
                repartitionActuelle = repartitionReste ' Répartition du reste sur les autres mois
            End If
            
            ' Ajouter au dictionnaire ou mettre à jour les valeurs
            If Not dict.exists(moisAnnee) Then
                dict.Add moisAnnee, Array(volume * repartitionActuelle, camions * repartitionActuelle, camionsCCC * repartitionActuelle)
            Else
                tempArray = dict(moisAnnee)
                tempArray(0) = tempArray(0) + (volume * repartitionActuelle)   ' Mettre à jour le volume
                tempArray(1) = tempArray(1) + (camions * repartitionActuelle)  ' Mettre à jour les camions
                tempArray(2) = tempArray(2) + (camionsCCC * repartitionActuelle) ' Mettre à jour les camions CCC
                dict(moisAnnee) = tempArray ' Réassigner le tableau mis à jour au dictionnaire
            End If
        Next k
    Next i
    
    
    
    ' Créer un tableau temporaire pour stocker et trier les dates
    ReDim moisArray(dict.Count - 1)
    
    ' Copier les clés (mois/année) sous forme de dates dans le tableau
    i = 0
    For Each key In dict.keys
        moisArray(i) = DateValue(key & "-01") ' Ajouter un jour pour convertir en date
        i = i + 1
    Next key
    
    ' Trier le tableau de dates
    Do
        sorted = True
        For i = LBound(moisArray) To UBound(moisArray) - 1
            If moisArray(i) > moisArray(i + 1) Then
                ' Échanger les valeurs
                Dim temp As Date
                temp = moisArray(i)
                moisArray(i) = moisArray(i + 1)
                moisArray(i + 1) = temp
                sorted = False
            End If
        Next i
    Loop Until sorted
    
    ' Remplir la feuille des flux mensuels avec les données agrégées
    ws.Cells(1, 13).Value = "Mois"
    ws.Cells(1, 14).Value = "Volume (nombre de palettes équivalentes)"
    ws.Cells(1, 15).Value = "Nombre de Camions"
    ws.Cells(1, 16).Value = "Nombre de Camions CCC"
    
    ' Remplir la feuille des flux mensuels avec les données triées par mois
    j = 2
    For i = LBound(moisArray) To UBound(moisArray)
        Dim sortedKey As String
        sortedKey = Format(moisArray(i), "yyyy-mm")
        
        ' Remplir les données agrégées dans la feuille
        ws.Cells(j, 13).Value = sortedKey
        ws.Cells(j, 14).Value = dict(sortedKey)(0) ' Volume total
        ws.Cells(j, 15).Value = dict(sortedKey)(1) ' Nombre de camions total
        ws.Cells(j, 16).Value = dict(sortedKey)(2) ' Nombre de camions total CCC
        j = j + 1
    Next i

    ' Créer un graphique de flux mensuel
    Set chartObj = wsBilan.ChartObjects.Add(Left:=50, Width:=500, Top:=350 + wsBilan.Cells(lastRow2 + 2, 1).Top, Height:=300)
    Set Chart = chartObj.Chart

    ' Configurer les données du graphique
    Chart.SetSourceData Source:=ws.Range("M1:O" & j - 1)
    Chart.ChartType = xlColumnClustered ' Histogramme groupé pour comparer les volumes et camions par mois
    
    ' Définir le type du graphique : histogramme pour le volume et courbe pour le nombre de camions
    Chart.ChartType = xlColumnClustered ' Histogramme pour le volume (par défaut)
    Chart.SeriesCollection(1).Name = "Nombre de palettes"
    Chart.SeriesCollection(2).Name = "Nombre de Camions"

    ' Configurer la série "Nombre de Camions" comme une courbe
    With Chart.SeriesCollection(2)
    .ChartType = xlLine ' Série "Nombre de Camions" en courbe
    .Smooth = True  ' Appliquer un adoucissement pour obtenir une courbe
    .AxisGroup = 2  ' Assigner à un axe secondaire
    End With
    
    ' Configurer les titres et les axes
    Chart.HasTitle = True
    Chart.ChartTitle.Text = "Flux Mensuel de Livraison"
    Chart.Axes(xlCategory, xlPrimary).HasTitle = True
    Chart.Axes(xlCategory, xlPrimary).AxisTitle.Text = "Mois"
    
    ' Ajouter des titres aux axes primaires et secondaires
    Chart.Axes(xlValue, xlPrimary).HasTitle = True
    Chart.Axes(xlValue, xlPrimary).AxisTitle.Text = "Nombre de palettes"
    Chart.Axes(xlValue, xlSecondary).HasTitle = True
    Chart.Axes(xlValue, xlSecondary).AxisTitle.Text = "Nombre de Camions"
   
    ' Copiez le graphique
    chartObj.Copy
    
    ' Collez-le temporairement sur la feuille Livrable (par exemple, en A1)
    wsLivrable.Activate
    wsLivrable.Range("A1").Select
    wsLivrable.Paste
    
    ' Ajustez la position et la taille du graphique collé
    With wsLivrable.ChartObjects(wsLivrable.ChartObjects.Count)
        .Left = 1
        .Top = 522
        .Width = 478
        .Height = 188.5
        With .Chart
            ' Titre principal
            .ChartTitle.Font.Size = 12
        
            ' Titres des axes
            .Axes(xlCategory).AxisTitle.Font.Size = 7
            .Axes(xlCategory).TickLabels.Font.Size = 7
            .Axes(xlValue, xlPrimary).AxisTitle.Font.Size = 7
            .Axes(xlValue, xlPrimary).TickLabels.Font.Size = 7
            .Axes(xlValue, xlSecondary).AxisTitle.Font.Size = 7
            .Axes(xlValue, xlSecondary).TickLabels.Font.Size = 7
        
            ' Légende
            .Legend.Font.Size = 7
        End With
    End With
    
    ' Créer un graphique de flux mensuel
    Set chartObj = wsBilan.ChartObjects.Add(Left:=50, Width:=500, Top:=350 + wsBilan.Cells(lastRow2 + 2, 1).Top, Height:=300)
    Set Chart = chartObj.Chart

    ' Configurer les données du graphique
    Chart.SetSourceData Source:=Union(ws.Range("M1:M" & j - 1), ws.Range("N1:N" & j - 1), ws.Range("P1:P" & j - 1))
    Chart.ChartType = xlColumnClustered ' Histogramme groupé pour comparer les volumes et camions par mois
    
    ' Définir le type du graphique : histogramme pour le volume et courbe pour le nombre de camions
    Chart.ChartType = xlColumnClustered ' Histogramme pour le volume (par défaut)
    Chart.SeriesCollection(1).Name = "Nombre de palettes"
    Chart.SeriesCollection(2).Name = "Nombre de Camions"

    ' Configurer la série "Nombre de Camions" comme une courbe
    With Chart.SeriesCollection(2)
    .ChartType = xlLine ' Série "Nombre de Camions" en courbe
    .Smooth = True  ' Appliquer un adoucissement pour obtenir une courbe
    .AxisGroup = 2  ' Assigner à un axe secondaire
    End With
    
    ' Configurer les titres et les axes
    Chart.HasTitle = True
    Chart.ChartTitle.Text = "Flux Mensuel de Livraison"
    Chart.Axes(xlCategory, xlPrimary).HasTitle = True
    Chart.Axes(xlCategory, xlPrimary).AxisTitle.Text = "Mois"
    
    ' Ajouter des titres aux axes primaires et secondaires
    Chart.Axes(xlValue, xlPrimary).HasTitle = True
    Chart.Axes(xlValue, xlPrimary).AxisTitle.Text = "Nombre de palettes"
    Chart.Axes(xlValue, xlSecondary).HasTitle = True
    Chart.Axes(xlValue, xlSecondary).AxisTitle.Text = "Nombre de Camions"
   
    ' Copiez le graphique
    chartObj.Copy
    
    ' Collez-le temporairement sur la feuille Livrable (par exemple, en A1)
    wsLivrable.Activate
    wsLivrable.Range("A1").Select
    wsLivrable.Paste
    
    ' Ajustez la position et la taille du graphique collé
    With wsLivrable.ChartObjects(wsLivrable.ChartObjects.Count)
        .Left = 482
        .Top = 522
        .Width = 477
        .Height = 188.5
        With .Chart
            ' Titre principal
            .ChartTitle.Font.Size = 12
        
            ' Titres des axes
            .Axes(xlCategory).AxisTitle.Font.Size = 7
            .Axes(xlCategory).TickLabels.Font.Size = 7
            .Axes(xlValue, xlPrimary).AxisTitle.Font.Size = 7
            .Axes(xlValue, xlPrimary).TickLabels.Font.Size = 7
            .Axes(xlValue, xlSecondary).AxisTitle.Font.Size = 7
            .Axes(xlValue, xlSecondary).TickLabels.Font.Size = 7
        
            ' Légende
            .Legend.Font.Size = 7
        End With
    End With
    
   
    ' Créer un graphique de flux mensuel AVEC r2SO
    Set chartObj = wsBilan.ChartObjects.Add(Left:=50, Width:=500, Top:=700 + wsBilan.Cells(lastRow2 + 2, 1).Top, Height:=300)
    Set Chart = chartObj.Chart

    ' Configurer les données du graphique
    Chart.SetSourceData Source:=ws.Range("M1:P" & j - 1)
    Chart.ChartType = xlColumnClustered ' Histogramme groupé pour comparer les volumes et camions par mois
    
    ' Définir le type du graphique : histogramme pour le volume et courbe pour le nombre de camions
    Chart.SeriesCollection(1).Name = "Nombre de palettes"
    Chart.SeriesCollection(2).Name = "Non Optimisée"
    Chart.SeriesCollection(3).Name = "Optimisée"

    ' Configurer la série "Nombre de Camions sans CCC" comme une courbe
    With Chart.SeriesCollection(1)
    .XValues = ws.Range("M2:M" & j - 1) ' Mois
    .Values = ws.Range("N2:N" & j - 1) ' Nombre de palettes
    .ChartType = xlColumnClustered  ' Série "Nombre de palettes" en histogramme
    .AxisGroup = 1
    End With
    
    ' Configurer la série "Nombre de Camions sans CCC" comme une courbe
    With Chart.SeriesCollection(2)
    .XValues = ws.Range("M2:M" & j - 1) ' Mois
    .Values = ws.Range("O2:O" & j - 1)
    .ChartType = xlLine ' Série "Nombre de Camions" en courbe
    .Smooth = True  ' Appliquer un adoucissement pour obtenir une courbe
    .AxisGroup = 2  ' Assigner à un axe secondaire
    End With
    
    ' Configurer la série "Nombre de Camions avec CCC" comme une courbe
    With Chart.SeriesCollection(3)
    .XValues = ws.Range("M2:M" & j - 1) ' Mois
    .Values = ws.Range("P2:P" & j - 1)
    .ChartType = xlLine ' Série "Nombre de Camions" en courbe
    .Smooth = True  ' Appliquer un adoucissement pour obtenir une courbe
    .AxisGroup = 2  ' Assigner à un axe secondaire
    End With
    
    ' Configurer les titres et les axes
    Chart.HasTitle = True
    Chart.ChartTitle.Text = "Comparatif Flux Mensuel de Livraison avec ou sans Optimisation"
    Chart.Axes(xlCategory, xlPrimary).HasTitle = True
    Chart.Axes(xlCategory, xlPrimary).AxisTitle.Text = "Mois"
    
    ' Ajouter des titres aux axes primaires et secondaires
    Chart.Axes(xlValue, xlPrimary).HasTitle = True
    Chart.Axes(xlValue, xlPrimary).AxisTitle.Text = "Nombre de palettes"
    Chart.Axes(xlValue, xlSecondary).HasTitle = True
    Chart.Axes(xlValue, xlSecondary).AxisTitle.Text = "Nombre de Camions"


    ' Copiez le graphique
    chartObj.Copy
    
    ' Collez-le temporairement sur la feuille Livrable (par exemple, en A1)
    wsLivrable.Activate
    wsLivrable.Range("A1").Select
    wsLivrable.Paste
    
    ' Ajustez la position et la taille du graphique collé
    With wsLivrable.ChartObjects(wsLivrable.ChartObjects.Count)
        .Left = 1080
        .Top = 377
        .Width = 359
        .Height = 188.5
        With .Chart
            ' Titre principal
            .ChartTitle.Font.Size = 12
        
            ' Titres des axes
            .Axes(xlCategory).AxisTitle.Font.Size = 7
            .Axes(xlCategory).TickLabels.Font.Size = 7
            .Axes(xlValue, xlPrimary).AxisTitle.Font.Size = 7
            .Axes(xlValue, xlPrimary).TickLabels.Font.Size = 7
            .Axes(xlValue, xlSecondary).AxisTitle.Font.Size = 7
            .Axes(xlValue, xlSecondary).TickLabels.Font.Size = 7

            ' Légende
            .Legend.Font.Size = 7
        End With
    End With

End Sub






Module 05: 
Sub CreerHistogrammeNombreCamions()
    Dim ws As Worksheet, wsBilan As Worksheet, wsLivrable As Worksheet
    Dim chartObj As ChartObject
    Dim Chart As Chart
    Dim i As Long
    Dim lastRow As Long, lastRow2 As Long
    
    ' Définir la feuille
    Set ws = ThisWorkbook.Sheets("Bilan Graphique")
    Set wsBilan = ThisWorkbook.Sheets("Bilan")
    Set wsLivrable = ThisWorkbook.Sheets("Livrable")

    ' Dernière ligne de données
    lastRow = ws.Cells(ws.Rows.Count, 9).End(xlUp).Row
    lastRow2 = wsBilan.Cells(ws.Rows.Count, 3).End(xlUp).Row

    ' Créer un nouvel objet graphique
    Set chartObj = wsBilan.ChartObjects.Add(Left:=700, Width:=500, Top:=350 + wsBilan.Cells(lastRow2 + 2, 1).Top, Height:=300)
    Set Chart = chartObj.Chart

    ' Définir le type de graphique (histogramme empilé)
    Chart.ChartType = xlColumnStacked

    ' Ajouter les séries de données
    Chart.SetSourceData Source:=ws.Range("G2:H" & lastRow)
    
    ' Configurer l'axe des catégories pour correspondre aux étages
    Chart.Axes(xlCategory).CategoryNames = ws.Range("F2:F" & lastRow)

    ' Configurer la légende (pour avoir "Production" et "Terminaux")
    Chart.HasLegend = True
    Chart.SeriesCollection(1).Name = "Camions Production"
    Chart.SeriesCollection(2).Name = "Camions Terminaux"

    
    ' Ajouter un titre au graphique
    Chart.HasTitle = True
    Chart.ChartTitle.Text = "Camions par étage"
    

    ' Ajouter un titre à l'axe des abscisses (axe des catégories)
    Chart.Axes(xlCategory, xlPrimary).HasTitle = True
    Chart.Axes(xlCategory, xlPrimary).AxisTitle.Text = "Étage et Zone" ' Titre de l'axe des abscisses

    ' Ajouter un titre à l'axe des ordonnées (axe des valeurs)
    Chart.Axes(xlValue, xlPrimary).HasTitle = True
    Chart.Axes(xlValue, xlPrimary).AxisTitle.Text = "Nombre de camions" ' Titre de l'axe des ordonnées
   
    ' Copiez le graphique
    chartObj.Copy
    
    ' Collez-le temporairement sur la feuille Livrable (par exemple, en A1)
    wsLivrable.Activate
    wsLivrable.Range("A1").Select
    wsLivrable.Paste
    
    ' Ajustez la position et la taille du graphique collé
    With wsLivrable.ChartObjects(wsLivrable.ChartObjects.Count)
        .Left = 1
        .Top = 304.5
        .Width = 300
        .Height = 174
        With .Chart
            ' Titre principal
            .ChartTitle.Font.Size = 12
        
            ' Titres des axes
            .Axes(xlCategory).AxisTitle.Font.Size = 7
            .Axes(xlCategory).TickLabels.Font.Size = 7
            .Axes(xlValue).AxisTitle.Font.Size = 7
            .Axes(xlValue).TickLabels.Font.Size = 7
            .Axes(xlCategory).TickLabels.Font.Size = 5
        
            ' Légende
            .Legend.Font.Size = 7
        End With
    End With
    
    ' Créer un nouvel objet graphique
    Set chartObj = wsBilan.ChartObjects.Add(Left:=700, Width:=500, Top:=350 + wsBilan.Cells(lastRow2 + 2, 1).Top, Height:=300)
    Set Chart = chartObj.Chart

    ' Définir le type de graphique (histogramme empilé)
    Chart.ChartType = xlColumnStacked

    ' Ajouter les séries de données
    Chart.SetSourceData Source:=ws.Range("I3:J" & lastRow)
    
    ' Configurer l'axe des catégories pour correspondre aux étages
    Chart.Axes(xlCategory).CategoryNames = ws.Range("F2:F" & lastRow)

    ' Configurer la légende (pour avoir "Production" et "Terminaux")
    Chart.HasLegend = True
    Chart.SeriesCollection(1).Name = "Camions Production"
    Chart.SeriesCollection(2).Name = "Camions Terminaux"

    
    ' Ajouter un titre au graphique
    Chart.HasTitle = True
    Chart.ChartTitle.Text = "Camions par étage"
    

    ' Ajouter un titre à l'axe des abscisses (axe des catégories)
    Chart.Axes(xlCategory, xlPrimary).HasTitle = True
    Chart.Axes(xlCategory, xlPrimary).AxisTitle.Text = "Étage et Zone" ' Titre de l'axe des abscisses

    ' Ajouter un titre à l'axe des ordonnées (axe des valeurs)
    Chart.Axes(xlValue, xlPrimary).HasTitle = True
    Chart.Axes(xlValue, xlPrimary).AxisTitle.Text = "Nombre de camions" ' Titre de l'axe des ordonnées
   
    ' Copiez le graphique
    chartObj.Copy
    
    ' Collez-le temporairement sur la feuille Livrable (par exemple, en A1)
    wsLivrable.Activate
    wsLivrable.Range("A1").Select
    wsLivrable.Paste
    
    ' Ajustez la position et la taille du graphique collé
    With wsLivrable.ChartObjects(wsLivrable.ChartObjects.Count)
        .Left = 482
        .Top = 304.5
        .Width = 300
        .Height = 174
        With .Chart
            ' Titre principal
            .ChartTitle.Font.Size = 12
        
            ' Titres des axes
            .Axes(xlCategory).AxisTitle.Font.Size = 7
            .Axes(xlCategory).TickLabels.Font.Size = 7
            .Axes(xlValue).AxisTitle.Font.Size = 7
            .Axes(xlValue).TickLabels.Font.Size = 7
            .Axes(xlCategory).TickLabels.Font.Size = 5
            
            
            ' Légende
            .Legend.Font.Size = 7
        End With
    End With
   
   
    ' Créer un nouvel objet graphique
    Set chartObj = wsBilan.ChartObjects.Add(Left:=700, Width:=500, Top:=700 + wsBilan.Cells(lastRow2 + 2, 1).Top, Height:=300)
    Set Chart = chartObj.Chart

    ' Définir le type de graphique (histogramme empilé)
    Chart.ChartType = xlColumnStacked

    ' Ajouter les séries de données
    Chart.SetSourceData Source:=ws.Range("G2:J" & lastRow)
    
    ' Configurer l'axe des catégories pour correspondre aux étages
    Chart.Axes(xlCategory).CategoryNames = ws.Range("F2:F" & lastRow)

    ' Configurer la légende (pour avoir "Production" et "Terminaux")
    Chart.HasLegend = True
    Chart.SeriesCollection(1).Name = "Production"
    Chart.SeriesCollection(2).Name = "Terminaux"
    Chart.SeriesCollection(3).Name = "Production Opti"
    Chart.SeriesCollection(4).Name = "Terminaux Opti"
    
    ' Ajouter un titre au graphique
    Chart.HasTitle = True
    Chart.ChartTitle.Text = "Comparatif Nombre de camions par étage avec ou sans Optimisation"
    

    ' Ajouter un titre à l'axe des abscisses (axe des catégories)
    Chart.Axes(xlCategory, xlPrimary).HasTitle = True
    Chart.Axes(xlCategory, xlPrimary).AxisTitle.Text = "Étage et Zone" ' Titre de l'axe des abscisses

    ' Ajouter un titre à l'axe des ordonnées (axe des valeurs)
    Chart.Axes(xlValue, xlPrimary).HasTitle = True
    Chart.Axes(xlValue, xlPrimary).AxisTitle.Text = "Nombre de camions" ' Titre de l'axe des ordonnées
    
    ' Copiez le graphique
    chartObj.Copy
    
    ' Collez-le temporairement sur la feuille Livrable (par exemple, en A1)
    wsLivrable.Activate
    wsLivrable.Range("A1").Select
    wsLivrable.Paste
    
    ' Ajustez la position et la taille du graphique collé
    With wsLivrable.ChartObjects(wsLivrable.ChartObjects.Count)
        .Left = 1080
        .Top = 174
        .Width = 359
        .Height = 188.5
        With .Chart
            ' Titre principal
            .ChartTitle.Font.Size = 12
        
            ' Titres des axes
            .Axes(xlCategory).AxisTitle.Font.Size = 7
            .Axes(xlValue).AxisTitle.Font.Size = 7
            .Axes(xlValue).TickLabels.Font.Size = 7
            .Axes(xlCategory).TickLabels.Font.Size = 5
        
            ' Légende
            .Legend.Font.Size = 7
        End With
    End With

End Sub


Sub CreerLivrable()
    Dim ws As Worksheet, wsBilan As Worksheet, wsParametrage As Worksheet, wsBilanGraphique As Worksheet, wsSource As Worksheet
    Dim total As Double, totalProd As Double, totalTerm As Double
    Dim lastRowSource As Long, lastRowParametrage As Long, lastRowBilanGraphique As Long, lastRowBilanGraphique2 As Long
    Dim moyenneDelai As Double
    Dim totalCamion As Double, totalCamionProd As Double, totalCamionTerm As Double
    Dim remplissageMoyen As Double, moisPic As String, volumePic As Double, camionPic As Double
    Dim totalCamionCCC As Double, totalCamionProdCCC As Double, totalCamionTermCCC As Double
    Dim remplissageMoyenCCC As Double, moisPicCCC As String, volumePicCCC As Double, camionPicCCC As Double
    Dim stockCCC As Double, remplissageAmelioration  As Double, camionAmelioration As Double
    Dim plateauGruePetit As Double, plateauGrueGrand As Double, camionnette As Double, fourgon8 As Double, fourgon12 As Double, camion20 As Double, camion30 As Double, porteur12 As Double, porteur19 As Double, semiremorque As Double
    Dim i As Long
    Dim ListeMaterielOpti As String
    Dim Cellule As Range
    
    ' Définir les feuilles et les variables
    Set ws = ThisWorkbook.Sheets("Livrable")
    Set wsBilan = ThisWorkbook.Sheets("Bilan")
    Set wsParametrage = ThisWorkbook.Sheets("Paramétrage")
    Set wsBilanGraphique = ThisWorkbook.Sheets("Bilan Graphique")
    Set wsSource = ThisWorkbook.Sheets("Tableau Source")
    lastRowSource = wsBilan.Range("C" & wsBilan.Rows.Count).End(xlUp).Row
    lastRowBilanGraphique = wsBilanGraphique.Range("M" & wsBilanGraphique.Rows.Count).End(xlUp).Row
    lastRowBilanGraphique2 = wsBilanGraphique.Range("AA" & wsBilanGraphique.Rows.Count).End(xlUp).Row
    



    With Union(ws.Range("H1:H4"), ws.Range("P1:P4"), ws.Range("X1:X4"))
        .Merge
        .Characters(1, 15).Font.Bold = False
        .Value = Date
        .HorizontalAlignment = xlRight
        .VerticalAlignment = xlTop
        .WrapText = True
        .Font.Size = 10  ' Définit la police des autres éléments à 14
    End With
    
    total = wsBilan.Range("D" & lastRowSource).Value
    totalProd = wsBilan.Range("D" & (lastRowSource - 2)).Value
    totalTerm = wsBilan.Range("D" & (lastRowSource - 1)).Value
    lastRowParametrage = wsParametrage.Range("J" & wsParametrage.Rows.Count).End(xlUp).Row
    
    ' Calcul de la moyenne des délais de livraison
    moyenneDelai = Application.WorksheetFunction.Average(wsParametrage.Range("J3:J" & lastRowParametrage))

    ' Préparer le texte avec les valeurs de variables
    Dim texte As String
    texte = total & " palettes équivalentes" & vbCrLf & vbCrLf & _
            Format(total * 1.2 * 0.8, "0.00") & " m² occupé au sol" & vbCrLf & vbCrLf & _
            " Palette Européenne (80 x 120 cm) :"

    ' Fusionner et formater la zone de texte dans la plage C22:H42
    With ws.Range("A13:C19")
        .Merge
        .Value = texte
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlTop
        .WrapText = True
        .Font.Size = 10  ' Définit la police des autres éléments à 14
    End With


    
    
    totalCamion = wsBilan.Range("I" & lastRowSource).Value
    totalCamionProd = wsBilan.Range("I" & (lastRowSource - 2)).Value
    totalCamionTerm = wsBilan.Range("I" & (lastRowSource - 1)).Value
    remplissageMoyen = wsBilan.Range("K" & lastRowSource).Value
    
    camionPic = Application.WorksheetFunction.Max(wsBilanGraphique.Range("O2:O" & lastRowBilanGraphique)) ' Colonne O pour les camions
    
    ' Recherchez la ligne où le nombre de camions est maximum et obtenez les valeurs correspondantes
    For i = 2 To lastRowBilanGraphique ' On part de la ligne 2
        If wsBilanGraphique.Cells(i, 15).Value = camionPic Then
            moisPic = wsBilanGraphique.Cells(i, 13).Value2      ' Colonne M pour les dates/mois
            volumePic = wsBilanGraphique.Cells(i, 14).Value   ' Colonne N pour les volumes
            Exit For
        End If
    Next i

    Dim texteBase As String, texteBase2 As String
    texteBase = "Pic de livraison :" & vbCrLf & _
            "En " & Format(moisPic, "mmmm yyyy") & ", " & Application.WorksheetFunction.RoundUp(camionPic / 4, 0) & " camions/semaine"

    texteBase2 = totalCamion & " camions" & vbCrLf & _
            "Remplissage moyen : " & Format(remplissageMoyen, "0%")
    
          
    With ws.Range("A34:E36")
        .Merge
        .Characters.Font.Bold = True
        .Value = texteBase
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlTop
        .WrapText = True
        .Font.Size = 12  ' Définit la police des autres éléments à 14
    End With
    
    With ws.Range("F34:H36")
        .Merge
        .Characters.Font.Bold = True
        .Value = texteBase2
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlTop
        .WrapText = True
        .Font.Size = 12  ' Définit la police des autres éléments à 14
    End With


    

    ' Initialiser la liste
    ListeMateriel = "Matériels stockés en CCC : "
    If wsBilanGraphique.Range("AA2") <> "" Then
        ' Parcourir les cellules de la colonne pour construire la liste
        For Each Cellule In wsBilanGraphique.Range("AA2:AA" & lastRowBilanGraphique2)
                ListeMateriel = ListeMateriel & Cellule.Value & ", " ' Ajouter avec une virgule
        Next Cellule
        ListeMateriel = Left(ListeMateriel, Len(ListeMateriel) - 2)
    Else
        ListeMateriel = ListeMateriel & "Aucun matériel stocké en CCC"
    End If
    
    With ws.Range("I16:P20")
        .Merge
        .Characters.Font.Bold = False
        .Value = ListeMateriel
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .WrapText = True
        .Font.Size = 10  ' Définit la police des autres éléments à 14
    End With
    
    With ws.Range("I16")
        .Characters(1, 26).Font.Bold = True
        .Font.Size = 10  ' Définit la police des autres éléments à 14
    End With
    
    totalCamionCCC = wsBilan.Range("J" & lastRowSource).Value
    totalCamionProdCCC = wsBilan.Range("J" & (lastRowSource - 2)).Value
    totalCamionTermCCC = wsBilan.Range("J" & (lastRowSource - 1)).Value
    remplissageMoyenCCC = wsBilan.Range("L" & lastRowSource).Value
    
    
    camionPicCCC = Application.WorksheetFunction.Max(wsBilanGraphique.Range("P2:P" & lastRowBilanGraphique)) ' Colonne O pour les camions
    
    ' Recherchez la ligne où le nombre de camions est maximum et obtenez les valeurs correspondantes
    For i = 2 To lastRowBilanGraphique ' On part de la ligne 2
        If wsBilanGraphique.Cells(i, 15).Value = camionPic Then
            moisPicCCC = wsBilanGraphique.Cells(i, 13).Value2      ' Colonne M pour les dates/mois
            volumePicCCC = wsBilanGraphique.Cells(i, 14).Value   ' Colonne N pour les volumes
            Exit For
        End If
    Next i
    
    Dim texteOpti As String, texteOpti2 As String
    texteOpti = "Pic de livraison :" & vbCrLf & _
            "En " & Format(moisPicCCC, "mmmm yyyy") & ", " & Application.WorksheetFunction.RoundUp(camionPicCCC / 4, 0) & " camions/semaine"

    texteOpti2 = totalCamionCCC & " camions" & vbCrLf & _
            "Remplissage moyen : " & Format(remplissageMoyenCCC, "0%")
    
          
    With ws.Range("I34:M36")
        .Merge
        .Characters.Font.Bold = True
        .Value = texteOpti
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlTop
        .WrapText = True
        .Font.Size = 12  ' Définit la police des autres éléments à 14
    End With
    
    With ws.Range("N34:P36")
        .Merge
        .Characters.Font.Bold = True
        .Value = texteOpti2
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlTop
        .WrapText = True
        .Font.Size = 12  ' Définit la police des autres éléments à 14
    End With

    
    
    
    
    ws.Range("H23").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Plateau Grue Petit")
    ws.Range("H24").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Plateau Grue Grand")
    ws.Range("H25").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Camionnette 6m3")
    ws.Range("H26").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Fourgon 7-9m3")
    ws.Range("H27").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Fourgon 10-12m3")
    ws.Range("H28").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Camion 20-22 m3")
    ws.Range("H29").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Camion 30 m3")
    ws.Range("H30").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Porteur 12 tonnes")
    ws.Range("H31").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Porteur 19 tonnes")
    ws.Range("H32").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(21), wsBilanGraphique.Columns(20), "Semi-remorque 90 m3")


    With ws.Range("H23:H32")
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .WrapText = True
        .Font.Size = 10
    End With
    
    
    ws.Range("P23").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Plateau Grue Petit")
    ws.Range("P24").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Plateau Grue Grand")
    ws.Range("P25").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Camionnette 6m3")
    ws.Range("P26").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Fourgon 7-9m3")
    ws.Range("P27").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Fourgon 10-12m3")
    ws.Range("P28").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Camion 20-22 m3")
    ws.Range("P29").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Camion 30 m3")
    ws.Range("P30").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Porteur 12 tonnes")
    ws.Range("P31").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Porteur 19 tonnes")
    ws.Range("P32").Value = Application.WorksheetFunction.SumIfs(wsBilanGraphique.Columns(25), wsBilanGraphique.Columns(24), "Semi-remorque 90 m3")

    With ws.Range("P23:P32")
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .WrapText = True
        .Font.Size = 10
    End With
    
    
    
    stockCCC = Application.WorksheetFunction.SumIfs(wsSource.Columns(11), wsSource.Columns(5), "Stock CCC Production") + _
                Application.WorksheetFunction.SumIfs(wsSource.Columns(11), wsSource.Columns(5), "Stock CCC Terminaux")
    camionAmelioration = Abs(((totalCamionCCC - totalCamion) / totalCamion))
    remplissageAmelioration = ((remplissageMoyenCCC - remplissageMoyen) / remplissageMoyen)
    dureeCCC = wsParametrage.Range("B4").Value
    prixstockageCCC = (wsParametrage.Range("B5").Value * dureeCCC + wsParametrage.Range("B6").Value) * stockCCC
    prixlivraisonCCC = wsParametrage.Range("B7").Value * stockCCC / 9
    prixCCC = prixstockageCCC + prixlivraisonCCC
    
    
    With wsBilanGraphique
        ' ===== LIBELLÉS (ligne 1) =====
        .Range("AE1").Value = "% Stock CCC"
        .Range("AF1").Value = "% réduction Camions"
        .Range("AG1").Value = "% remplissage moyen des camions"
        .Range("AH1").Value = "Coût CCC stockage"
        .Range("AI1").Value = "Coût CCC livraison"
        .Range("AJ1").Value = "Coût CCC Total"
    
        ' ===== VALEURS (ligne 2) =====
        .Range("AE2").Value = stockCCC / total
        .Range("AF2").Value = camionAmelioration
        .Range("AG2").Value = remplissageAmelioration
        .Range("AH2").Value = prixstockageCCC
        .Range("AI2").Value = prixlivraisonCCC
        .Range("AJ2").Value = prixCCC
    
        ' ===== FORMATS =====
        .Range("AE2:AG2").NumberFormat = "0%"
        .Range("AH2:AJ2").NumberFormat = "#,##0 €"
    End With

    
    
    
    
    
    Dim texteAmeliorations As String
    texteAmeliorations = "Avec " & Format(stockCCC / total, "0%") & " du matériel stocké" & vbCrLf & _
            "dans un CCC pendant " & vbCrLf & _
            dureeCCC & " mois :" & vbCrLf & vbCrLf & _
            " - " & Format(camionAmelioration, "0%") & " de camions" & vbCrLf & vbCrLf & _
            " " & IIf(remplissageAmelioration >= 0, "+", "-") & Format(Abs(remplissageAmelioration), "0%") & " du" & vbCrLf & _
            "remplissage moyen"

    
    With ws.Range("Q15:R29")
        .Merge
        .Characters.Font.Bold = True
        .Value = texteAmeliorations
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlTop
        .WrapText = True
        .Font.Size = 14  ' Définit la police des autres éléments à 14
    End With
    
    Dim texteCCC As String
    texteCCC = "Coût CCC : " & vbCrLf & vbCrLf & _
            "Stockage : " & Format(prixstockageCCC, 0) & "€" & vbCrLf & _
            "Livraison : " & Format(prixlivraisonCCC, 0) & "€" & vbCrLf & vbCrLf & _
            "Total : " & Format(prixCCC, 0) & "€"

    
    With ws.Range("Q30:R37")
        .Merge
        .Characters.Font.Bold = False
        .Value = texteCCC
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlTop
        .WrapText = True
        .Font.Size = 12  ' Définit la police des autres éléments à 14
    End With
    
    With ws.Range("Q30")
        .Characters(1, 10).Font.Bold = True
        .Characters(1, 10).Font.Size = 14  ' Définit la police des autres éléments à 14
    End With


End Sub






Function OptimiserRemplissage(lastRowDonnees As Long, typeCamion As String, nbPalettes As Long) As String
    Dim wsCamion As Worksheet
    Dim i As Long, nbCamions As Long
    Dim capaciteCamion As Long
    Dim meilleurNbCamions As Long
    Dim meilleurTauxRemplissage As Double
    Dim tauxRemplissage As Double
    Dim palettesDernierCamion As Long
    Dim tauxDernierCamion As Double
    Dim camionChoisi As String
    Dim lastRowCamion As Long
    
    ' Définir la feuille "Camion"
    Set wsCamion = ThisWorkbook.Sheets("Camion")
    lastRowCamion = wsCamion.Cells(wsCamion.Rows.Count, "A").End(xlUp).Row
    
    ' Initialiser les variables
    meilleurNbCamions = 9999   ' Valeur élevée pour comparer
    meilleurTauxRemplissage = 0
    camionChoisi = ""
    
    ' Parcourir les camions
    For i = 2 To lastRowCamion
        ' Vérifier si le type de camion correspond
        If wsCamion.Cells(i, 2).Value = typeCamion Then
            capaciteCamion = wsCamion.Cells(i, 3).Value
            
            ' Calculer le nombre de camions nécessaires (au moins 1)
            nbCamions = Application.WorksheetFunction.Max(1, _
                          Application.WorksheetFunction.Ceiling(nbPalettes / capaciteCamion, 1))
            
            ' Calculer le taux de remplissage moyen
            tauxRemplissage = (nbPalettes / (nbCamions * capaciteCamion)) * 100
            
            ' Calculer le nombre de palettes dans le dernier camion
            palettesDernierCamion = nbPalettes Mod capaciteCamion
            If palettesDernierCamion = 0 Then
                tauxDernierCamion = 100
            Else
                tauxDernierCamion = (palettesDernierCamion / capaciteCamion) * 100
            End If
            
            ' Si le nombre de palettes est égal à 1, on sélectionne le camion qui offre le meilleur taux de remplissage
            If nbPalettes = 1 Then
                If tauxRemplissage > meilleurTauxRemplissage Then
                    camionChoisi = wsCamion.Cells(i, 1).Value
                    meilleurTauxRemplissage = tauxRemplissage
                End If
            Else
                ' Pour nbPalettes > 1, on choisit le camion en fonction du nombre de camions nécessaires et du taux de remplissage
                If nbCamions < meilleurNbCamions Or _
                   (nbCamions = meilleurNbCamions And tauxRemplissage > meilleurTauxRemplissage And tauxDernierCamion > 50) Then
                    camionChoisi = wsCamion.Cells(i, 1).Value
                    meilleurNbCamions = nbCamions
                    meilleurTauxRemplissage = tauxRemplissage
                End If
            End If
        End If
    Next i
    
    ' Retourner le camion choisi
    OptimiserRemplissage = camionChoisi
End Function


